{"ast":null,"code":"module.exports = Reader;\n\nvar fs = require('graceful-fs');\n\nvar Stream = require('stream').Stream;\n\nvar inherits = require('inherits');\n\nvar path = require('path');\n\nvar getType = require('./get-type.js');\n\nvar hardLinks = Reader.hardLinks = {};\n\nvar Abstract = require('./abstract.js'); // Must do this *before* loading the child classes\n\n\ninherits(Reader, Abstract);\n\nvar LinkReader = require('./link-reader.js');\n\nfunction Reader(props, currentStat) {\n  var self = this;\n  if (!(self instanceof Reader)) return new Reader(props, currentStat);\n\n  if (typeof props === 'string') {\n    props = {\n      path: props\n    };\n  } // polymorphism.\n  // call fstream.Reader(dir) to get a DirReader object, etc.\n  // Note that, unlike in the Writer case, ProxyReader is going\n  // to be the *normal* state of affairs, since we rarely know\n  // the type of a file prior to reading it.\n\n\n  var type;\n  var ClassType;\n\n  if (props.type && typeof props.type === 'function') {\n    type = props.type;\n    ClassType = type;\n  } else {\n    type = getType(props);\n    ClassType = Reader;\n  }\n\n  if (currentStat && !type) {\n    type = getType(currentStat);\n    props[type] = true;\n    props.type = type;\n  }\n\n  switch (type) {\n    case 'Directory':\n      ClassType = require('./dir-reader.js');\n      break;\n\n    case 'Link': // XXX hard links are just files.\n    // However, it would be good to keep track of files' dev+inode\n    // and nlink values, and create a HardLinkReader that emits\n    // a linkpath value of the original copy, so that the tar\n    // writer can preserve them.\n    // ClassType = HardLinkReader\n    // break\n\n    case 'File':\n      ClassType = require('./file-reader.js');\n      break;\n\n    case 'SymbolicLink':\n      ClassType = LinkReader;\n      break;\n\n    case 'Socket':\n      ClassType = require('./socket-reader.js');\n      break;\n\n    case null:\n      ClassType = require('./proxy-reader.js');\n      break;\n  }\n\n  if (!(self instanceof ClassType)) {\n    return new ClassType(props);\n  }\n\n  Abstract.call(self);\n\n  if (!props.path) {\n    self.error('Must provide a path', null, true);\n  }\n\n  self.readable = true;\n  self.writable = false;\n  self.type = type;\n  self.props = props;\n  self.depth = props.depth = props.depth || 0;\n  self.parent = props.parent || null;\n  self.root = props.root || props.parent && props.parent.root || self;\n  self._path = self.path = path.resolve(props.path);\n\n  if (process.platform === 'win32') {\n    self.path = self._path = self.path.replace(/\\?/g, '_');\n\n    if (self._path.length >= 260) {\n      // how DOES one create files on the moon?\n      // if the path has spaces in it, then UNC will fail.\n      self._swallowErrors = true; // if (self._path.indexOf(\" \") === -1) {\n\n      self._path = '\\\\\\\\?\\\\' + self.path.replace(/\\//g, '\\\\'); // }\n    }\n  }\n\n  self.basename = props.basename = path.basename(self.path);\n  self.dirname = props.dirname = path.dirname(self.path); // these have served their purpose, and are now just noisy clutter\n\n  props.parent = props.root = null; // console.error(\"\\n\\n\\n%s setting size to\", props.path, props.size)\n\n  self.size = props.size;\n  self.filter = typeof props.filter === 'function' ? props.filter : null;\n  if (props.sort === 'alpha') props.sort = alphasort; // start the ball rolling.\n  // this will stat the thing, and then call self._read()\n  // to start reading whatever it is.\n  // console.error(\"calling stat\", props.path, currentStat)\n\n  self._stat(currentStat);\n}\n\nfunction alphasort(a, b) {\n  return a === b ? 0 : a.toLowerCase() > b.toLowerCase() ? 1 : a.toLowerCase() < b.toLowerCase() ? -1 : a > b ? 1 : -1;\n}\n\nReader.prototype._stat = function (currentStat) {\n  var self = this;\n  var props = self.props;\n  var stat = props.follow ? 'stat' : 'lstat'; // console.error(\"Reader._stat\", self._path, currentStat)\n\n  if (currentStat) process.nextTick(statCb.bind(null, null, currentStat));else fs[stat](self._path, statCb);\n\n  function statCb(er, props_) {\n    // console.error(\"Reader._stat, statCb\", self._path, props_, props_.nlink)\n    if (er) return self.error(er);\n    Object.keys(props_).forEach(function (k) {\n      props[k] = props_[k];\n    }); // if it's not the expected size, then abort here.\n\n    if (undefined !== self.size && props.size !== self.size) {\n      return self.error('incorrect size');\n    }\n\n    self.size = props.size;\n    var type = getType(props);\n    var handleHardlinks = props.hardlinks !== false; // special little thing for handling hardlinks.\n\n    if (handleHardlinks && type !== 'Directory' && props.nlink && props.nlink > 1) {\n      var k = props.dev + ':' + props.ino; // console.error(\"Reader has nlink\", self._path, k)\n\n      if (hardLinks[k] === self._path || !hardLinks[k]) {\n        hardLinks[k] = self._path;\n      } else {\n        // switch into hardlink mode.\n        type = self.type = self.props.type = 'Link';\n        self.Link = self.props.Link = true;\n        self.linkpath = self.props.linkpath = hardLinks[k]; // console.error(\"Hardlink detected, switching mode\", self._path, self.linkpath)\n        // Setting __proto__ would arguably be the \"correct\"\n        // approach here, but that just seems too wrong.\n\n        self._stat = self._read = LinkReader.prototype._read;\n      }\n    }\n\n    if (self.type && self.type !== type) {\n      self.error('Unexpected type: ' + type);\n    } // if the filter doesn't pass, then just skip over this one.\n    // still have to emit end so that dir-walking can move on.\n\n\n    if (self.filter) {\n      var who = self._proxy || self; // special handling for ProxyReaders\n\n      if (!self.filter.call(who, who, props)) {\n        if (!self._disowned) {\n          self.abort();\n          self.emit('end');\n          self.emit('close');\n        }\n\n        return;\n      }\n    } // last chance to abort or disown before the flow starts!\n\n\n    var events = ['_stat', 'stat', 'ready'];\n    var e = 0;\n\n    (function go() {\n      if (self._aborted) {\n        self.emit('end');\n        self.emit('close');\n        return;\n      }\n\n      if (self._paused && self.type !== 'Directory') {\n        self.once('resume', go);\n        return;\n      }\n\n      var ev = events[e++];\n\n      if (!ev) {\n        return self._read();\n      }\n\n      self.emit(ev, props);\n      go();\n    })();\n  }\n};\n\nReader.prototype.pipe = function (dest) {\n  var self = this;\n\n  if (typeof dest.add === 'function') {\n    // piping to a multi-compatible, and we've got directory entries.\n    self.on('entry', function (entry) {\n      var ret = dest.add(entry);\n\n      if (ret === false) {\n        self.pause();\n      }\n    });\n  } // console.error(\"R Pipe apply Stream Pipe\")\n\n\n  return Stream.prototype.pipe.apply(this, arguments);\n};\n\nReader.prototype.pause = function (who) {\n  this._paused = true;\n  who = who || this;\n  this.emit('pause', who);\n  if (this._stream) this._stream.pause(who);\n};\n\nReader.prototype.resume = function (who) {\n  this._paused = false;\n  who = who || this;\n  this.emit('resume', who);\n  if (this._stream) this._stream.resume(who);\n\n  this._read();\n};\n\nReader.prototype._read = function () {\n  this.error('Cannot read unknown type: ' + this.type);\n};","map":{"version":3,"sources":["/home/dev/Documentos/Projects/github-clone/node_modules/fstream/lib/reader.js"],"names":["module","exports","Reader","fs","require","Stream","inherits","path","getType","hardLinks","Abstract","LinkReader","props","currentStat","self","type","ClassType","call","error","readable","writable","depth","parent","root","_path","resolve","process","platform","replace","length","_swallowErrors","basename","dirname","size","filter","sort","alphasort","_stat","a","b","toLowerCase","prototype","stat","follow","nextTick","statCb","bind","er","props_","Object","keys","forEach","k","undefined","handleHardlinks","hardlinks","nlink","dev","ino","Link","linkpath","_read","who","_proxy","_disowned","abort","emit","events","e","go","_aborted","_paused","once","ev","pipe","dest","add","on","entry","ret","pause","apply","arguments","_stream","resume"],"mappings":"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","sourcesContent":["module.exports = Reader\n\nvar fs = require('graceful-fs')\nvar Stream = require('stream').Stream\nvar inherits = require('inherits')\nvar path = require('path')\nvar getType = require('./get-type.js')\nvar hardLinks = Reader.hardLinks = {}\nvar Abstract = require('./abstract.js')\n\n// Must do this *before* loading the child classes\ninherits(Reader, Abstract)\n\nvar LinkReader = require('./link-reader.js')\n\nfunction Reader (props, currentStat) {\n  var self = this\n  if (!(self instanceof Reader)) return new Reader(props, currentStat)\n\n  if (typeof props === 'string') {\n    props = { path: props }\n  }\n\n  // polymorphism.\n  // call fstream.Reader(dir) to get a DirReader object, etc.\n  // Note that, unlike in the Writer case, ProxyReader is going\n  // to be the *normal* state of affairs, since we rarely know\n  // the type of a file prior to reading it.\n\n  var type\n  var ClassType\n\n  if (props.type && typeof props.type === 'function') {\n    type = props.type\n    ClassType = type\n  } else {\n    type = getType(props)\n    ClassType = Reader\n  }\n\n  if (currentStat && !type) {\n    type = getType(currentStat)\n    props[type] = true\n    props.type = type\n  }\n\n  switch (type) {\n    case 'Directory':\n      ClassType = require('./dir-reader.js')\n      break\n\n    case 'Link':\n    // XXX hard links are just files.\n    // However, it would be good to keep track of files' dev+inode\n    // and nlink values, and create a HardLinkReader that emits\n    // a linkpath value of the original copy, so that the tar\n    // writer can preserve them.\n    // ClassType = HardLinkReader\n    // break\n\n    case 'File':\n      ClassType = require('./file-reader.js')\n      break\n\n    case 'SymbolicLink':\n      ClassType = LinkReader\n      break\n\n    case 'Socket':\n      ClassType = require('./socket-reader.js')\n      break\n\n    case null:\n      ClassType = require('./proxy-reader.js')\n      break\n  }\n\n  if (!(self instanceof ClassType)) {\n    return new ClassType(props)\n  }\n\n  Abstract.call(self)\n\n  if (!props.path) {\n    self.error('Must provide a path', null, true)\n  }\n\n  self.readable = true\n  self.writable = false\n\n  self.type = type\n  self.props = props\n  self.depth = props.depth = props.depth || 0\n  self.parent = props.parent || null\n  self.root = props.root || (props.parent && props.parent.root) || self\n\n  self._path = self.path = path.resolve(props.path)\n  if (process.platform === 'win32') {\n    self.path = self._path = self.path.replace(/\\?/g, '_')\n    if (self._path.length >= 260) {\n      // how DOES one create files on the moon?\n      // if the path has spaces in it, then UNC will fail.\n      self._swallowErrors = true\n      // if (self._path.indexOf(\" \") === -1) {\n      self._path = '\\\\\\\\?\\\\' + self.path.replace(/\\//g, '\\\\')\n    // }\n    }\n  }\n  self.basename = props.basename = path.basename(self.path)\n  self.dirname = props.dirname = path.dirname(self.path)\n\n  // these have served their purpose, and are now just noisy clutter\n  props.parent = props.root = null\n\n  // console.error(\"\\n\\n\\n%s setting size to\", props.path, props.size)\n  self.size = props.size\n  self.filter = typeof props.filter === 'function' ? props.filter : null\n  if (props.sort === 'alpha') props.sort = alphasort\n\n  // start the ball rolling.\n  // this will stat the thing, and then call self._read()\n  // to start reading whatever it is.\n  // console.error(\"calling stat\", props.path, currentStat)\n  self._stat(currentStat)\n}\n\nfunction alphasort (a, b) {\n  return a === b ? 0\n    : a.toLowerCase() > b.toLowerCase() ? 1\n      : a.toLowerCase() < b.toLowerCase() ? -1\n        : a > b ? 1\n          : -1\n}\n\nReader.prototype._stat = function (currentStat) {\n  var self = this\n  var props = self.props\n  var stat = props.follow ? 'stat' : 'lstat'\n  // console.error(\"Reader._stat\", self._path, currentStat)\n  if (currentStat) process.nextTick(statCb.bind(null, null, currentStat))\n  else fs[stat](self._path, statCb)\n\n  function statCb (er, props_) {\n    // console.error(\"Reader._stat, statCb\", self._path, props_, props_.nlink)\n    if (er) return self.error(er)\n\n    Object.keys(props_).forEach(function (k) {\n      props[k] = props_[k]\n    })\n\n    // if it's not the expected size, then abort here.\n    if (undefined !== self.size && props.size !== self.size) {\n      return self.error('incorrect size')\n    }\n    self.size = props.size\n\n    var type = getType(props)\n    var handleHardlinks = props.hardlinks !== false\n\n    // special little thing for handling hardlinks.\n    if (handleHardlinks && type !== 'Directory' && props.nlink && props.nlink > 1) {\n      var k = props.dev + ':' + props.ino\n      // console.error(\"Reader has nlink\", self._path, k)\n      if (hardLinks[k] === self._path || !hardLinks[k]) {\n        hardLinks[k] = self._path\n      } else {\n        // switch into hardlink mode.\n        type = self.type = self.props.type = 'Link'\n        self.Link = self.props.Link = true\n        self.linkpath = self.props.linkpath = hardLinks[k]\n        // console.error(\"Hardlink detected, switching mode\", self._path, self.linkpath)\n        // Setting __proto__ would arguably be the \"correct\"\n        // approach here, but that just seems too wrong.\n        self._stat = self._read = LinkReader.prototype._read\n      }\n    }\n\n    if (self.type && self.type !== type) {\n      self.error('Unexpected type: ' + type)\n    }\n\n    // if the filter doesn't pass, then just skip over this one.\n    // still have to emit end so that dir-walking can move on.\n    if (self.filter) {\n      var who = self._proxy || self\n      // special handling for ProxyReaders\n      if (!self.filter.call(who, who, props)) {\n        if (!self._disowned) {\n          self.abort()\n          self.emit('end')\n          self.emit('close')\n        }\n        return\n      }\n    }\n\n    // last chance to abort or disown before the flow starts!\n    var events = ['_stat', 'stat', 'ready']\n    var e = 0\n    ;(function go () {\n      if (self._aborted) {\n        self.emit('end')\n        self.emit('close')\n        return\n      }\n\n      if (self._paused && self.type !== 'Directory') {\n        self.once('resume', go)\n        return\n      }\n\n      var ev = events[e++]\n      if (!ev) {\n        return self._read()\n      }\n      self.emit(ev, props)\n      go()\n    })()\n  }\n}\n\nReader.prototype.pipe = function (dest) {\n  var self = this\n  if (typeof dest.add === 'function') {\n    // piping to a multi-compatible, and we've got directory entries.\n    self.on('entry', function (entry) {\n      var ret = dest.add(entry)\n      if (ret === false) {\n        self.pause()\n      }\n    })\n  }\n\n  // console.error(\"R Pipe apply Stream Pipe\")\n  return Stream.prototype.pipe.apply(this, arguments)\n}\n\nReader.prototype.pause = function (who) {\n  this._paused = true\n  who = who || this\n  this.emit('pause', who)\n  if (this._stream) this._stream.pause(who)\n}\n\nReader.prototype.resume = function (who) {\n  this._paused = false\n  who = who || this\n  this.emit('resume', who)\n  if (this._stream) this._stream.resume(who)\n  this._read()\n}\n\nReader.prototype._read = function () {\n  this.error('Cannot read unknown type: ' + this.type)\n}\n"]},"metadata":{},"sourceType":"script"}