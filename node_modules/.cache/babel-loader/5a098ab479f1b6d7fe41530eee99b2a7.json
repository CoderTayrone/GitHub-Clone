{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.checkAvailability = exports.existingBackend = exports.scheduleIdForFunction = exports.topicName = exports.scheduleName = exports.sameFunctionName = exports.functionName = exports.isEmptyBackend = exports.empty = exports.SCHEDULED_FUNCTION_LABEL = exports.memoryOptionDisplayName = exports.triggerTag = exports.isEventTrigger = void 0;\n\nconst gcf = require(\"../../gcp/cloudfunctions\");\n\nconst gcfV2 = require(\"../../gcp/cloudfunctionsv2\");\n\nconst utils = require(\"../../utils\");\n\nconst error_1 = require(\"../../error\");\n\nconst previews_1 = require(\"../../previews\");\n\nfunction isEventTrigger(trigger) {\n  return \"eventType\" in trigger;\n}\n\nexports.isEventTrigger = isEventTrigger;\n\nfunction triggerTag(fn) {\n  var _a, _b;\n\n  if ((_a = fn.labels) === null || _a === void 0 ? void 0 : _a[\"deployment-scheduled\"]) {\n    if (fn.platform === \"gcfv1\") {\n      return \"v1.scheduled\";\n    }\n\n    return \"v2.scheduled\";\n  }\n\n  if ((_b = fn.labels) === null || _b === void 0 ? void 0 : _b[\"deployment-callable\"]) {\n    if (fn.platform === \"gcfv1\") {\n      return \"v1.callable\";\n    }\n\n    return \"v2.callable\";\n  }\n\n  if (!isEventTrigger(fn.trigger)) {\n    if (fn.platform === \"gcfv1\") {\n      return \"v1.https\";\n    }\n\n    return \"v2.https\";\n  }\n\n  return fn.trigger.eventType;\n}\n\nexports.triggerTag = triggerTag;\n\nfunction memoryOptionDisplayName(option) {\n  return {\n    128: \"128MB\",\n    256: \"256MB\",\n    512: \"512MB\",\n    1024: \"1GB\",\n    2048: \"2GB\",\n    4096: \"4GB\",\n    8192: \"8GB\"\n  }[option];\n}\n\nexports.memoryOptionDisplayName = memoryOptionDisplayName;\nexports.SCHEDULED_FUNCTION_LABEL = Object.freeze({\n  deployment: \"firebase-schedule\"\n});\n\nfunction empty() {\n  return {\n    requiredAPIs: {},\n    cloudFunctions: [],\n    schedules: [],\n    topics: [],\n    environmentVariables: {}\n  };\n}\n\nexports.empty = empty;\n\nfunction isEmptyBackend(backend) {\n  return Object.keys(backend.requiredAPIs).length == 0 && backend.cloudFunctions.length === 0 && backend.schedules.length === 0 && backend.topics.length === 0;\n}\n\nexports.isEmptyBackend = isEmptyBackend;\n\nfunction functionName(cloudFunction) {\n  return `projects/${cloudFunction.project}/locations/${cloudFunction.region}/functions/${cloudFunction.id}`;\n}\n\nexports.functionName = functionName;\n\nexports.sameFunctionName = func => test => {\n  return func.id === test.id && func.region === test.region && func.project == test.project;\n};\n\nfunction scheduleName(schedule, appEngineLocation) {\n  return `projects/${schedule.project}/locations/${appEngineLocation}/jobs/${schedule.id}`;\n}\n\nexports.scheduleName = scheduleName;\n\nfunction topicName(topic) {\n  return `projects/${topic.project}/topics/${topic.id}`;\n}\n\nexports.topicName = topicName;\n\nfunction scheduleIdForFunction(cloudFunction) {\n  return `firebase-schedule-${cloudFunction.id}-${cloudFunction.region}`;\n}\n\nexports.scheduleIdForFunction = scheduleIdForFunction;\n\nasync function existingBackend(context, forceRefresh) {\n  const ctx = context;\n\n  if (!ctx.loadedExistingBackend || forceRefresh) {\n    await loadExistingBackend(ctx);\n  }\n\n  return ctx.existingBackend;\n}\n\nexports.existingBackend = existingBackend;\n\nasync function loadExistingBackend(ctx) {\n  var _a, _b, _c;\n\n  ctx.loadedExistingBackend = true;\n  ctx.existingBackend = {\n    requiredAPIs: {},\n    cloudFunctions: [],\n    schedules: [],\n    topics: [],\n    environmentVariables: {}\n  };\n  ctx.unreachableRegions = {\n    gcfV1: [],\n    gcfV2: []\n  };\n  const gcfV1Results = await gcf.listAllFunctions(ctx.projectId);\n\n  for (const apiFunction of gcfV1Results.functions) {\n    const specFunction = gcf.specFromFunction(apiFunction);\n    ctx.existingBackend.cloudFunctions.push(specFunction);\n    const isScheduled = ((_a = apiFunction.labels) === null || _a === void 0 ? void 0 : _a[\"deployment-scheduled\"]) === \"true\";\n\n    if (isScheduled) {\n      const id = scheduleIdForFunction(specFunction);\n      ctx.existingBackend.schedules.push({\n        id,\n        project: specFunction.project,\n        transport: \"pubsub\",\n        targetService: {\n          id: specFunction.id,\n          region: specFunction.region,\n          project: specFunction.project\n        }\n      });\n      ctx.existingBackend.topics.push({\n        id,\n        project: specFunction.project,\n        labels: exports.SCHEDULED_FUNCTION_LABEL,\n        targetService: {\n          id: specFunction.id,\n          region: specFunction.region,\n          project: specFunction.project\n        }\n      });\n    }\n  }\n\n  ctx.unreachableRegions.gcfV1 = gcfV1Results.unreachable;\n\n  if (!previews_1.previews.functionsv2) {\n    return;\n  }\n\n  const gcfV2Results = await gcfV2.listAllFunctions(ctx.projectId);\n\n  for (const apiFunction of gcfV2Results.functions) {\n    const specFunction = gcfV2.specFromFunction(apiFunction);\n    ctx.existingBackend.cloudFunctions.push(specFunction);\n    const pubsubScheduled = ((_b = apiFunction.labels) === null || _b === void 0 ? void 0 : _b[\"deployment-scheduled\"]) === \"true\";\n    const httpsScheduled = ((_c = apiFunction.labels) === null || _c === void 0 ? void 0 : _c[\"deployment-scheduled\"]) === \"https\";\n\n    if (pubsubScheduled) {\n      const id = scheduleIdForFunction(specFunction);\n      ctx.existingBackend.schedules.push({\n        id,\n        project: specFunction.project,\n        transport: \"pubsub\",\n        targetService: {\n          id: specFunction.id,\n          region: specFunction.region,\n          project: specFunction.project\n        }\n      });\n      ctx.existingBackend.topics.push({\n        id,\n        project: specFunction.project,\n        labels: exports.SCHEDULED_FUNCTION_LABEL,\n        targetService: {\n          id: specFunction.id,\n          region: specFunction.region,\n          project: specFunction.project\n        }\n      });\n    }\n\n    if (httpsScheduled) {\n      const id = scheduleIdForFunction(specFunction);\n      ctx.existingBackend.schedules.push({\n        id,\n        project: specFunction.project,\n        transport: \"https\",\n        targetService: {\n          id: specFunction.id,\n          region: specFunction.region,\n          project: specFunction.project\n        }\n      });\n    }\n  }\n\n  ctx.unreachableRegions.gcfV2 = gcfV2Results.unreachable;\n}\n\nasync function checkAvailability(context, want) {\n  const ctx = context;\n\n  if (!ctx.loadedExistingBackend) {\n    await loadExistingBackend(ctx);\n  }\n\n  const gcfV1Regions = new Set();\n  const gcfV2Regions = new Set();\n\n  for (const fn of want.cloudFunctions) {\n    if (fn.platform == \"gcfv1\") {\n      gcfV1Regions.add(fn.region);\n    } else {\n      gcfV2Regions.add(fn.region);\n    }\n  }\n\n  const neededUnreachableV1 = ctx.unreachableRegions.gcfV1.filter(region => gcfV1Regions.has(region));\n  const neededUnreachableV2 = ctx.unreachableRegions.gcfV2.filter(region => gcfV2Regions.has(region));\n\n  if (neededUnreachableV1.length) {\n    throw new error_1.FirebaseError(\"The following Cloud Functions regions are currently unreachable:\\n\\t\" + neededUnreachableV1.join(\"\\n\\t\") + \"\\nThis deployment contains functions in those regions. Please try again in a few minutes, or exclude these regions from your deployment.\");\n  }\n\n  if (neededUnreachableV2.length) {\n    throw new error_1.FirebaseError(\"The following Cloud Functions V2 regions are currently unreachable:\\n\\t\" + neededUnreachableV2.join(\"\\n\\t\") + \"\\nThis deployment contains functions in those regions. Please try again in a few minutes, or exclude these regions from your deployment.\");\n  }\n\n  if (ctx.unreachableRegions.gcfV1.length) {\n    utils.logLabeledWarning(\"functions\", \"The following Cloud Functions regions are currently unreachable:\\n\" + ctx.unreachableRegions.gcfV1.join(\"\\n\") + \"\\nCloud Functions in these regions won't be deleted.\");\n  }\n\n  if (ctx.unreachableRegions.gcfV2.length) {\n    utils.logLabeledWarning(\"functions\", \"The following Cloud Functions V2 regions are currently unreachable:\\n\" + ctx.unreachableRegions.gcfV2.join(\"\\n\") + \"\\nCloud Functions in these regions won't be deleted.\");\n  }\n}\n\nexports.checkAvailability = checkAvailability;","map":{"version":3,"sources":["/home/dev/Documentos/Projects/github-clone/node_modules/firebase-tools/lib/deploy/functions/backend.js"],"names":["Object","defineProperty","exports","value","checkAvailability","existingBackend","scheduleIdForFunction","topicName","scheduleName","sameFunctionName","functionName","isEmptyBackend","empty","SCHEDULED_FUNCTION_LABEL","memoryOptionDisplayName","triggerTag","isEventTrigger","gcf","require","gcfV2","utils","error_1","previews_1","trigger","fn","_a","_b","labels","platform","eventType","option","freeze","deployment","requiredAPIs","cloudFunctions","schedules","topics","environmentVariables","backend","keys","length","cloudFunction","project","region","id","func","test","schedule","appEngineLocation","topic","context","forceRefresh","ctx","loadedExistingBackend","loadExistingBackend","_c","unreachableRegions","gcfV1","gcfV1Results","listAllFunctions","projectId","apiFunction","functions","specFunction","specFromFunction","push","isScheduled","transport","targetService","unreachable","previews","functionsv2","gcfV2Results","pubsubScheduled","httpsScheduled","want","gcfV1Regions","Set","gcfV2Regions","add","neededUnreachableV1","filter","has","neededUnreachableV2","FirebaseError","join","logLabeledWarning"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.checkAvailability = exports.existingBackend = exports.scheduleIdForFunction = exports.topicName = exports.scheduleName = exports.sameFunctionName = exports.functionName = exports.isEmptyBackend = exports.empty = exports.SCHEDULED_FUNCTION_LABEL = exports.memoryOptionDisplayName = exports.triggerTag = exports.isEventTrigger = void 0;\nconst gcf = require(\"../../gcp/cloudfunctions\");\nconst gcfV2 = require(\"../../gcp/cloudfunctionsv2\");\nconst utils = require(\"../../utils\");\nconst error_1 = require(\"../../error\");\nconst previews_1 = require(\"../../previews\");\nfunction isEventTrigger(trigger) {\n    return \"eventType\" in trigger;\n}\nexports.isEventTrigger = isEventTrigger;\nfunction triggerTag(fn) {\n    var _a, _b;\n    if ((_a = fn.labels) === null || _a === void 0 ? void 0 : _a[\"deployment-scheduled\"]) {\n        if (fn.platform === \"gcfv1\") {\n            return \"v1.scheduled\";\n        }\n        return \"v2.scheduled\";\n    }\n    if ((_b = fn.labels) === null || _b === void 0 ? void 0 : _b[\"deployment-callable\"]) {\n        if (fn.platform === \"gcfv1\") {\n            return \"v1.callable\";\n        }\n        return \"v2.callable\";\n    }\n    if (!isEventTrigger(fn.trigger)) {\n        if (fn.platform === \"gcfv1\") {\n            return \"v1.https\";\n        }\n        return \"v2.https\";\n    }\n    return fn.trigger.eventType;\n}\nexports.triggerTag = triggerTag;\nfunction memoryOptionDisplayName(option) {\n    return {\n        128: \"128MB\",\n        256: \"256MB\",\n        512: \"512MB\",\n        1024: \"1GB\",\n        2048: \"2GB\",\n        4096: \"4GB\",\n        8192: \"8GB\",\n    }[option];\n}\nexports.memoryOptionDisplayName = memoryOptionDisplayName;\nexports.SCHEDULED_FUNCTION_LABEL = Object.freeze({ deployment: \"firebase-schedule\" });\nfunction empty() {\n    return {\n        requiredAPIs: {},\n        cloudFunctions: [],\n        schedules: [],\n        topics: [],\n        environmentVariables: {},\n    };\n}\nexports.empty = empty;\nfunction isEmptyBackend(backend) {\n    return (Object.keys(backend.requiredAPIs).length == 0 &&\n        backend.cloudFunctions.length === 0 &&\n        backend.schedules.length === 0 &&\n        backend.topics.length === 0);\n}\nexports.isEmptyBackend = isEmptyBackend;\nfunction functionName(cloudFunction) {\n    return `projects/${cloudFunction.project}/locations/${cloudFunction.region}/functions/${cloudFunction.id}`;\n}\nexports.functionName = functionName;\nexports.sameFunctionName = (func) => (test) => {\n    return func.id === test.id && func.region === test.region && func.project == test.project;\n};\nfunction scheduleName(schedule, appEngineLocation) {\n    return `projects/${schedule.project}/locations/${appEngineLocation}/jobs/${schedule.id}`;\n}\nexports.scheduleName = scheduleName;\nfunction topicName(topic) {\n    return `projects/${topic.project}/topics/${topic.id}`;\n}\nexports.topicName = topicName;\nfunction scheduleIdForFunction(cloudFunction) {\n    return `firebase-schedule-${cloudFunction.id}-${cloudFunction.region}`;\n}\nexports.scheduleIdForFunction = scheduleIdForFunction;\nasync function existingBackend(context, forceRefresh) {\n    const ctx = context;\n    if (!ctx.loadedExistingBackend || forceRefresh) {\n        await loadExistingBackend(ctx);\n    }\n    return ctx.existingBackend;\n}\nexports.existingBackend = existingBackend;\nasync function loadExistingBackend(ctx) {\n    var _a, _b, _c;\n    ctx.loadedExistingBackend = true;\n    ctx.existingBackend = {\n        requiredAPIs: {},\n        cloudFunctions: [],\n        schedules: [],\n        topics: [],\n        environmentVariables: {},\n    };\n    ctx.unreachableRegions = {\n        gcfV1: [],\n        gcfV2: [],\n    };\n    const gcfV1Results = await gcf.listAllFunctions(ctx.projectId);\n    for (const apiFunction of gcfV1Results.functions) {\n        const specFunction = gcf.specFromFunction(apiFunction);\n        ctx.existingBackend.cloudFunctions.push(specFunction);\n        const isScheduled = ((_a = apiFunction.labels) === null || _a === void 0 ? void 0 : _a[\"deployment-scheduled\"]) === \"true\";\n        if (isScheduled) {\n            const id = scheduleIdForFunction(specFunction);\n            ctx.existingBackend.schedules.push({\n                id,\n                project: specFunction.project,\n                transport: \"pubsub\",\n                targetService: {\n                    id: specFunction.id,\n                    region: specFunction.region,\n                    project: specFunction.project,\n                },\n            });\n            ctx.existingBackend.topics.push({\n                id,\n                project: specFunction.project,\n                labels: exports.SCHEDULED_FUNCTION_LABEL,\n                targetService: {\n                    id: specFunction.id,\n                    region: specFunction.region,\n                    project: specFunction.project,\n                },\n            });\n        }\n    }\n    ctx.unreachableRegions.gcfV1 = gcfV1Results.unreachable;\n    if (!previews_1.previews.functionsv2) {\n        return;\n    }\n    const gcfV2Results = await gcfV2.listAllFunctions(ctx.projectId);\n    for (const apiFunction of gcfV2Results.functions) {\n        const specFunction = gcfV2.specFromFunction(apiFunction);\n        ctx.existingBackend.cloudFunctions.push(specFunction);\n        const pubsubScheduled = ((_b = apiFunction.labels) === null || _b === void 0 ? void 0 : _b[\"deployment-scheduled\"]) === \"true\";\n        const httpsScheduled = ((_c = apiFunction.labels) === null || _c === void 0 ? void 0 : _c[\"deployment-scheduled\"]) === \"https\";\n        if (pubsubScheduled) {\n            const id = scheduleIdForFunction(specFunction);\n            ctx.existingBackend.schedules.push({\n                id,\n                project: specFunction.project,\n                transport: \"pubsub\",\n                targetService: {\n                    id: specFunction.id,\n                    region: specFunction.region,\n                    project: specFunction.project,\n                },\n            });\n            ctx.existingBackend.topics.push({\n                id,\n                project: specFunction.project,\n                labels: exports.SCHEDULED_FUNCTION_LABEL,\n                targetService: {\n                    id: specFunction.id,\n                    region: specFunction.region,\n                    project: specFunction.project,\n                },\n            });\n        }\n        if (httpsScheduled) {\n            const id = scheduleIdForFunction(specFunction);\n            ctx.existingBackend.schedules.push({\n                id,\n                project: specFunction.project,\n                transport: \"https\",\n                targetService: {\n                    id: specFunction.id,\n                    region: specFunction.region,\n                    project: specFunction.project,\n                },\n            });\n        }\n    }\n    ctx.unreachableRegions.gcfV2 = gcfV2Results.unreachable;\n}\nasync function checkAvailability(context, want) {\n    const ctx = context;\n    if (!ctx.loadedExistingBackend) {\n        await loadExistingBackend(ctx);\n    }\n    const gcfV1Regions = new Set();\n    const gcfV2Regions = new Set();\n    for (const fn of want.cloudFunctions) {\n        if (fn.platform == \"gcfv1\") {\n            gcfV1Regions.add(fn.region);\n        }\n        else {\n            gcfV2Regions.add(fn.region);\n        }\n    }\n    const neededUnreachableV1 = ctx.unreachableRegions.gcfV1.filter((region) => gcfV1Regions.has(region));\n    const neededUnreachableV2 = ctx.unreachableRegions.gcfV2.filter((region) => gcfV2Regions.has(region));\n    if (neededUnreachableV1.length) {\n        throw new error_1.FirebaseError(\"The following Cloud Functions regions are currently unreachable:\\n\\t\" +\n            neededUnreachableV1.join(\"\\n\\t\") +\n            \"\\nThis deployment contains functions in those regions. Please try again in a few minutes, or exclude these regions from your deployment.\");\n    }\n    if (neededUnreachableV2.length) {\n        throw new error_1.FirebaseError(\"The following Cloud Functions V2 regions are currently unreachable:\\n\\t\" +\n            neededUnreachableV2.join(\"\\n\\t\") +\n            \"\\nThis deployment contains functions in those regions. Please try again in a few minutes, or exclude these regions from your deployment.\");\n    }\n    if (ctx.unreachableRegions.gcfV1.length) {\n        utils.logLabeledWarning(\"functions\", \"The following Cloud Functions regions are currently unreachable:\\n\" +\n            ctx.unreachableRegions.gcfV1.join(\"\\n\") +\n            \"\\nCloud Functions in these regions won't be deleted.\");\n    }\n    if (ctx.unreachableRegions.gcfV2.length) {\n        utils.logLabeledWarning(\"functions\", \"The following Cloud Functions V2 regions are currently unreachable:\\n\" +\n            ctx.unreachableRegions.gcfV2.join(\"\\n\") +\n            \"\\nCloud Functions in these regions won't be deleted.\");\n    }\n}\nexports.checkAvailability = checkAvailability;\n"]},"metadata":{},"sourceType":"script"}