{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.logout = exports.getAccessToken = exports.findAccountByEmail = exports.loginGithub = exports.loginGoogle = exports.setGlobalDefaultAccount = exports.setProjectAccount = exports.loginAdditionalAccount = exports.selectAccount = exports.setRefreshToken = exports.setActiveAccount = exports.getAllAccounts = exports.getAdditionalAccounts = exports.getProjectDefaultAccount = exports.getGlobalDefaultAccount = void 0;\n\nconst clc = require(\"cli-color\");\n\nconst fs = require(\"fs\");\n\nconst jwt = require(\"jsonwebtoken\");\n\nconst http = require(\"http\");\n\nconst opn = require(\"open\");\n\nconst path = require(\"path\");\n\nconst portfinder = require(\"portfinder\");\n\nconst url = require(\"url\");\n\nconst util = require(\"util\");\n\nconst api = require(\"./api\");\n\nconst apiv2 = require(\"./apiv2\");\n\nconst configstore_1 = require(\"./configstore\");\n\nconst error_1 = require(\"./error\");\n\nconst utils = require(\"./utils\");\n\nconst logger_1 = require(\"./logger\");\n\nconst prompt_1 = require(\"./prompt\");\n\nconst scopes = require(\"./scopes\");\n\nconst defaultCredentials_1 = require(\"./defaultCredentials\");\n\nportfinder.basePort = 9005;\n\nfunction getGlobalDefaultAccount() {\n  const user = configstore_1.configstore.get(\"user\");\n  const tokens = configstore_1.configstore.get(\"tokens\");\n\n  if (!user || !tokens) {\n    return undefined;\n  }\n\n  return {\n    user,\n    tokens\n  };\n}\n\nexports.getGlobalDefaultAccount = getGlobalDefaultAccount;\n\nfunction getProjectDefaultAccount(projectDir) {\n  if (!projectDir) {\n    return getGlobalDefaultAccount();\n  }\n\n  const activeAccounts = configstore_1.configstore.get(\"activeAccounts\") || {};\n  const email = activeAccounts[projectDir];\n\n  if (!email) {\n    return getGlobalDefaultAccount();\n  }\n\n  const allAccounts = getAllAccounts();\n  return allAccounts.find(a => a.user.email === email);\n}\n\nexports.getProjectDefaultAccount = getProjectDefaultAccount;\n\nfunction getAdditionalAccounts() {\n  return configstore_1.configstore.get(\"additionalAccounts\") || [];\n}\n\nexports.getAdditionalAccounts = getAdditionalAccounts;\n\nfunction getAllAccounts() {\n  const res = [];\n  const defaultUser = getGlobalDefaultAccount();\n\n  if (defaultUser) {\n    res.push(defaultUser);\n  }\n\n  res.push(...getAdditionalAccounts());\n  return res;\n}\n\nexports.getAllAccounts = getAllAccounts;\n\nfunction setActiveAccount(options, account) {\n  if (account.tokens.refresh_token) {\n    setRefreshToken(account.tokens.refresh_token);\n  }\n\n  options.user = account.user;\n  options.tokens = account.tokens;\n}\n\nexports.setActiveAccount = setActiveAccount;\n\nfunction setRefreshToken(token) {\n  api.setRefreshToken(token);\n  apiv2.setRefreshToken(token);\n}\n\nexports.setRefreshToken = setRefreshToken;\n\nfunction selectAccount(account, projectRoot) {\n  const defaultUser = getProjectDefaultAccount(projectRoot);\n\n  if (!account) {\n    return defaultUser;\n  }\n\n  if (!defaultUser) {\n    throw new error_1.FirebaseError(`Account ${account} not found, have you run \"firebase login\"?`);\n  }\n\n  const matchingAccount = getAllAccounts().find(a => a.user.email === account);\n\n  if (matchingAccount) {\n    return matchingAccount;\n  }\n\n  throw new error_1.FirebaseError(`Account ${account} not found, run \"firebase login:list\" to see existing accounts or \"firebase login:add\" to add a new one`);\n}\n\nexports.selectAccount = selectAccount;\n\nasync function loginAdditionalAccount(useLocalhost, email) {\n  const result = await loginGoogle(useLocalhost, email);\n\n  if (typeof result.user === \"string\") {\n    throw new error_1.FirebaseError(\"Failed to parse auth response, see debug log.\");\n  }\n\n  const resultEmail = result.user.email;\n\n  if (email && resultEmail !== email) {\n    utils.logWarning(`Chosen account ${resultEmail} does not match account hint ${email}`);\n  }\n\n  const allAccounts = getAllAccounts();\n  const newAccount = {\n    user: result.user,\n    tokens: result.tokens\n  };\n  const existingAccount = allAccounts.find(a => a.user.email === resultEmail);\n\n  if (existingAccount) {\n    utils.logWarning(`Already logged in as ${resultEmail}.`);\n    updateAccount(newAccount);\n  } else {\n    const additionalAccounts = getAdditionalAccounts();\n    additionalAccounts.push(newAccount);\n    configstore_1.configstore.set(\"additionalAccounts\", additionalAccounts);\n  }\n\n  return newAccount;\n}\n\nexports.loginAdditionalAccount = loginAdditionalAccount;\n\nfunction setProjectAccount(projectDir, email) {\n  logger_1.logger.debug(`setProjectAccount(${projectDir}, ${email})`);\n  const activeAccounts = configstore_1.configstore.get(\"activeAccounts\") || {};\n  activeAccounts[projectDir] = email;\n  configstore_1.configstore.set(\"activeAccounts\", activeAccounts);\n}\n\nexports.setProjectAccount = setProjectAccount;\n\nfunction setGlobalDefaultAccount(account) {\n  configstore_1.configstore.set(\"user\", account.user);\n  configstore_1.configstore.set(\"tokens\", account.tokens);\n  const additionalAccounts = getAdditionalAccounts();\n  const index = additionalAccounts.findIndex(a => a.user.email === account.user.email);\n\n  if (index >= 0) {\n    additionalAccounts.splice(index, 1);\n    configstore_1.configstore.set(\"additionalAccounts\", additionalAccounts);\n  }\n}\n\nexports.setGlobalDefaultAccount = setGlobalDefaultAccount;\n\nfunction open(url) {\n  opn(url).catch(err => {\n    logger_1.logger.debug(\"Unable to open URL: \" + err.stack);\n  });\n}\n\nfunction invalidCredentialError() {\n  return new error_1.FirebaseError(\"Authentication Error: Your credentials are no longer valid. Please run \" + clc.bold(\"firebase login --reauth\") + \"\\n\\n\" + \"For CI servers and headless environments, generate a new token with \" + clc.bold(\"firebase login:ci\"), {\n    exit: 1\n  });\n}\n\nconst FIFTEEN_MINUTES_IN_MS = 15 * 60 * 1000;\nconst SCOPES = [scopes.EMAIL, scopes.OPENID, scopes.CLOUD_PROJECTS_READONLY, scopes.FIREBASE_PLATFORM, scopes.CLOUD_PLATFORM];\n\nconst _nonce = Math.floor(Math.random() * (2 << 29) + 1).toString();\n\nconst getPort = portfinder.getPortPromise;\nlet lastAccessToken;\n\nfunction getCallbackUrl(port) {\n  if (typeof port === \"undefined\") {\n    return \"urn:ietf:wg:oauth:2.0:oob\";\n  }\n\n  return `http://localhost:${port}`;\n}\n\nfunction queryParamString(args) {\n  const tokens = [];\n\n  for (const [key, value] of Object.entries(args)) {\n    if (typeof value === \"string\") {\n      tokens.push(key + \"=\" + encodeURIComponent(value));\n    }\n  }\n\n  return tokens.join(\"&\");\n}\n\nfunction getLoginUrl(callbackUrl, userHint) {\n  return api.authOrigin + \"/o/oauth2/auth?\" + queryParamString({\n    client_id: api.clientId,\n    scope: SCOPES.join(\" \"),\n    response_type: \"code\",\n    state: _nonce,\n    redirect_uri: callbackUrl,\n    login_hint: userHint\n  });\n}\n\nasync function getTokensFromAuthorizationCode(code, callbackUrl) {\n  var _a, _b;\n\n  let res;\n\n  try {\n    res = await api.request(\"POST\", \"/o/oauth2/token\", {\n      origin: api.authOrigin,\n      form: {\n        code: code,\n        client_id: api.clientId,\n        client_secret: api.clientSecret,\n        redirect_uri: callbackUrl,\n        grant_type: \"authorization_code\"\n      }\n    });\n  } catch (err) {\n    if (err instanceof Error) {\n      logger_1.logger.debug(\"Token Fetch Error:\", err.stack || \"\");\n    } else {\n      logger_1.logger.debug(\"Token Fetch Error\");\n    }\n\n    throw invalidCredentialError();\n  }\n\n  if (!((_a = res === null || res === void 0 ? void 0 : res.body) === null || _a === void 0 ? void 0 : _a.access_token) && !((_b = res === null || res === void 0 ? void 0 : res.body) === null || _b === void 0 ? void 0 : _b.refresh_token)) {\n    logger_1.logger.debug(\"Token Fetch Error:\", res.statusCode, res.body);\n    throw invalidCredentialError();\n  }\n\n  lastAccessToken = Object.assign({\n    expires_at: Date.now() + res.body.expires_in * 1000\n  }, res.body);\n  return lastAccessToken;\n}\n\nconst GITHUB_SCOPES = [\"read:user\", \"repo\", \"public_repo\"];\n\nfunction getGithubLoginUrl(callbackUrl) {\n  return api.githubOrigin + \"/login/oauth/authorize?\" + queryParamString({\n    client_id: api.githubClientId,\n    state: _nonce,\n    redirect_uri: callbackUrl,\n    scope: GITHUB_SCOPES.join(\" \")\n  });\n}\n\nasync function getGithubTokensFromAuthorizationCode(code, callbackUrl) {\n  const res = await api.request(\"POST\", \"/login/oauth/access_token\", {\n    origin: api.githubOrigin,\n    form: {\n      client_id: api.githubClientId,\n      client_secret: api.githubClientSecret,\n      code,\n      redirect_uri: callbackUrl,\n      state: _nonce\n    }\n  });\n  return res.body.access_token;\n}\n\nasync function respondWithFile(req, res, statusCode, filename) {\n  const response = await util.promisify(fs.readFile)(path.join(__dirname, filename));\n  res.writeHead(statusCode, {\n    \"Content-Length\": response.length,\n    \"Content-Type\": \"text/html\"\n  });\n  res.end(response);\n  req.socket.destroy();\n}\n\nasync function loginWithoutLocalhost(userHint) {\n  const callbackUrl = getCallbackUrl();\n  const authUrl = getLoginUrl(callbackUrl, userHint);\n  logger_1.logger.info();\n  logger_1.logger.info(\"Visit this URL on any device to log in:\");\n  logger_1.logger.info(clc.bold.underline(authUrl));\n  logger_1.logger.info();\n  open(authUrl);\n  const code = await prompt_1.promptOnce({\n    type: \"input\",\n    name: \"code\",\n    message: \"Paste authorization code here:\"\n  });\n  const tokens = await getTokensFromAuthorizationCode(code, callbackUrl);\n  return {\n    user: jwt.decode(tokens.id_token),\n    tokens: tokens,\n    scopes: SCOPES\n  };\n}\n\nasync function loginWithLocalhostGoogle(port, userHint) {\n  const callbackUrl = getCallbackUrl(port);\n  const authUrl = getLoginUrl(callbackUrl, userHint);\n  const successTemplate = \"../templates/loginSuccess.html\";\n  const tokens = await loginWithLocalhost(port, callbackUrl, authUrl, successTemplate, getTokensFromAuthorizationCode);\n  return {\n    user: jwt.decode(tokens.id_token),\n    tokens: tokens,\n    scopes: tokens.scopes\n  };\n}\n\nasync function loginWithLocalhostGitHub(port) {\n  const callbackUrl = getCallbackUrl(port);\n  const authUrl = getGithubLoginUrl(callbackUrl);\n  const successTemplate = \"../templates/loginSuccessGithub.html\";\n  return loginWithLocalhost(port, callbackUrl, authUrl, successTemplate, getGithubTokensFromAuthorizationCode);\n}\n\nasync function loginWithLocalhost(port, callbackUrl, authUrl, successTemplate, getTokens) {\n  return new Promise((resolve, reject) => {\n    const server = http.createServer(async (req, res) => {\n      let tokens;\n      const query = url.parse(`${req.url}`, true).query || {};\n      const queryState = query.state;\n      const queryCode = query.code;\n\n      if (queryState !== _nonce || typeof queryCode !== \"string\") {\n        await respondWithFile(req, res, 400, \"../templates/loginFailure.html\");\n        reject(new error_1.FirebaseError(\"Unexpected error while logging in\"));\n        server.close();\n        return;\n      }\n\n      try {\n        const tokens = await getTokens(queryCode, callbackUrl);\n        await respondWithFile(req, res, 200, successTemplate);\n        resolve(tokens);\n      } catch (err) {\n        await respondWithFile(req, res, 400, \"../templates/loginFailure.html\");\n        reject(err);\n      }\n\n      server.close();\n      return;\n    });\n    server.listen(port, () => {\n      logger_1.logger.info();\n      logger_1.logger.info(\"Visit this URL on this device to log in:\");\n      logger_1.logger.info(clc.bold.underline(authUrl));\n      logger_1.logger.info();\n      logger_1.logger.info(\"Waiting for authentication...\");\n      open(authUrl);\n    });\n    server.on(\"error\", err => {\n      reject(err);\n    });\n  });\n}\n\nasync function loginGoogle(localhost, userHint) {\n  if (localhost) {\n    const port = await getPort();\n\n    try {\n      const port = await getPort();\n      return await loginWithLocalhostGoogle(port, userHint);\n    } catch (_a) {\n      return await loginWithoutLocalhost(userHint);\n    }\n  }\n\n  return await loginWithoutLocalhost(userHint);\n}\n\nexports.loginGoogle = loginGoogle;\n\nasync function loginGithub() {\n  const port = await getPort();\n  return loginWithLocalhostGitHub(port);\n}\n\nexports.loginGithub = loginGithub;\n\nfunction findAccountByEmail(email) {\n  return getAllAccounts().find(a => a.user.email === email);\n}\n\nexports.findAccountByEmail = findAccountByEmail;\n\nfunction haveValidTokens(refreshToken, authScopes) {\n  var _a;\n\n  if (!(lastAccessToken === null || lastAccessToken === void 0 ? void 0 : lastAccessToken.access_token)) {\n    const tokens = configstore_1.configstore.get(\"tokens\");\n\n    if (refreshToken === (tokens === null || tokens === void 0 ? void 0 : tokens.refresh_token)) {\n      lastAccessToken = tokens;\n    }\n  }\n\n  const hasTokens = !!(lastAccessToken === null || lastAccessToken === void 0 ? void 0 : lastAccessToken.access_token);\n  const oldScopesJSON = JSON.stringify(((_a = lastAccessToken === null || lastAccessToken === void 0 ? void 0 : lastAccessToken.scopes) === null || _a === void 0 ? void 0 : _a.sort()) || []);\n  const newScopesJSON = JSON.stringify(authScopes.sort());\n  const hasSameScopes = oldScopesJSON === newScopesJSON;\n  const isExpired = ((lastAccessToken === null || lastAccessToken === void 0 ? void 0 : lastAccessToken.expires_at) || 0) < Date.now() + FIFTEEN_MINUTES_IN_MS;\n  return hasTokens && hasSameScopes && !isExpired;\n}\n\nfunction deleteAccount(account) {\n  const defaultAccount = getGlobalDefaultAccount();\n\n  if (account.user.email === (defaultAccount === null || defaultAccount === void 0 ? void 0 : defaultAccount.user.email)) {\n    configstore_1.configstore.delete(\"user\");\n    configstore_1.configstore.delete(\"tokens\");\n    configstore_1.configstore.delete(\"usage\");\n    configstore_1.configstore.delete(\"analytics-uuid\");\n  }\n\n  const additionalAccounts = getAdditionalAccounts();\n  const remainingAccounts = additionalAccounts.filter(a => a.user.email !== account.user.email);\n  configstore_1.configstore.set(\"additionalAccounts\", remainingAccounts);\n  const activeAccounts = configstore_1.configstore.get(\"activeAccounts\") || {};\n\n  for (const [projectDir, projectAccount] of Object.entries(activeAccounts)) {\n    if (projectAccount === account.user.email) {\n      delete activeAccounts[projectDir];\n    }\n  }\n\n  configstore_1.configstore.set(\"activeAccounts\", activeAccounts);\n}\n\nfunction updateAccount(account) {\n  const defaultAccount = getGlobalDefaultAccount();\n\n  if (account.user.email === (defaultAccount === null || defaultAccount === void 0 ? void 0 : defaultAccount.user.email)) {\n    configstore_1.configstore.set(\"user\", account.user);\n    configstore_1.configstore.set(\"tokens\", account.tokens);\n  }\n\n  const additionalAccounts = getAdditionalAccounts();\n  const accountIndex = additionalAccounts.findIndex(a => a.user.email === account.user.email);\n\n  if (accountIndex >= 0) {\n    additionalAccounts.splice(accountIndex, 1, account);\n    configstore_1.configstore.set(\"additionalAccounts\", additionalAccounts);\n  }\n}\n\nfunction findAccountByRefreshToken(refreshToken) {\n  return getAllAccounts().find(a => a.tokens.refresh_token === refreshToken);\n}\n\nfunction logoutCurrentSession(refreshToken) {\n  const account = findAccountByRefreshToken(refreshToken);\n\n  if (!account) {\n    return;\n  }\n\n  defaultCredentials_1.clearCredentials(account);\n  deleteAccount(account);\n}\n\nasync function refreshTokens(refreshToken, authScopes) {\n  var _a, _b, _c;\n\n  logger_1.logger.debug(\"> refreshing access token with scopes:\", JSON.stringify(authScopes));\n\n  try {\n    const res = await api.request(\"POST\", \"/oauth2/v3/token\", {\n      origin: api.googleOrigin,\n      form: {\n        refresh_token: refreshToken,\n        client_id: api.clientId,\n        client_secret: api.clientSecret,\n        grant_type: \"refresh_token\",\n        scope: (authScopes || []).join(\" \")\n      },\n      logOptions: {\n        skipRequestBody: true,\n        skipQueryParams: true,\n        skipResponseBody: true\n      }\n    });\n\n    if (res.status === 401 || res.status === 400) {\n      return {\n        access_token: refreshToken\n      };\n    }\n\n    if (typeof ((_a = res.body) === null || _a === void 0 ? void 0 : _a.access_token) !== \"string\") {\n      throw invalidCredentialError();\n    }\n\n    lastAccessToken = Object.assign({\n      expires_at: Date.now() + res.body.expires_in * 1000,\n      refresh_token: refreshToken,\n      scopes: authScopes\n    }, res.body);\n    const account = findAccountByRefreshToken(refreshToken);\n\n    if (account && lastAccessToken) {\n      account.tokens = lastAccessToken;\n      updateAccount(account);\n    }\n\n    return lastAccessToken;\n  } catch (err) {\n    if (((_c = (_b = err === null || err === void 0 ? void 0 : err.context) === null || _b === void 0 ? void 0 : _b.body) === null || _c === void 0 ? void 0 : _c.error) === \"invalid_scope\") {\n      throw new error_1.FirebaseError(\"This command requires new authorization scopes not granted to your current session. Please run \" + clc.bold(\"firebase login --reauth\") + \"\\n\\n\" + \"For CI servers and headless environments, generate a new token with \" + clc.bold(\"firebase login:ci\"), {\n        exit: 1\n      });\n    }\n\n    throw invalidCredentialError();\n  }\n}\n\nasync function getAccessToken(refreshToken, authScopes) {\n  if (haveValidTokens(refreshToken, authScopes)) {\n    return lastAccessToken;\n  }\n\n  return refreshTokens(refreshToken, authScopes);\n}\n\nexports.getAccessToken = getAccessToken;\n\nasync function logout(refreshToken) {\n  if ((lastAccessToken === null || lastAccessToken === void 0 ? void 0 : lastAccessToken.refresh_token) === refreshToken) {\n    lastAccessToken = undefined;\n  }\n\n  logoutCurrentSession(refreshToken);\n\n  try {\n    await api.request(\"GET\", \"/o/oauth2/revoke\", {\n      origin: api.authOrigin,\n      data: {\n        token: refreshToken\n      }\n    });\n  } catch (thrown) {\n    const err = thrown instanceof Error ? thrown : new Error(thrown);\n    throw new error_1.FirebaseError(\"Authentication Error.\", {\n      exit: 1,\n      original: err\n    });\n  }\n}\n\nexports.logout = logout;","map":{"version":3,"sources":["/home/dev/Documentos/Projects/github-clone/node_modules/firebase-tools/lib/auth.js"],"names":["Object","defineProperty","exports","value","logout","getAccessToken","findAccountByEmail","loginGithub","loginGoogle","setGlobalDefaultAccount","setProjectAccount","loginAdditionalAccount","selectAccount","setRefreshToken","setActiveAccount","getAllAccounts","getAdditionalAccounts","getProjectDefaultAccount","getGlobalDefaultAccount","clc","require","fs","jwt","http","opn","path","portfinder","url","util","api","apiv2","configstore_1","error_1","utils","logger_1","prompt_1","scopes","defaultCredentials_1","basePort","user","configstore","get","tokens","undefined","projectDir","activeAccounts","email","allAccounts","find","a","res","defaultUser","push","options","account","refresh_token","token","projectRoot","FirebaseError","matchingAccount","useLocalhost","result","resultEmail","logWarning","newAccount","existingAccount","updateAccount","additionalAccounts","set","logger","debug","index","findIndex","splice","open","catch","err","stack","invalidCredentialError","bold","exit","FIFTEEN_MINUTES_IN_MS","SCOPES","EMAIL","OPENID","CLOUD_PROJECTS_READONLY","FIREBASE_PLATFORM","CLOUD_PLATFORM","_nonce","Math","floor","random","toString","getPort","getPortPromise","lastAccessToken","getCallbackUrl","port","queryParamString","args","key","entries","encodeURIComponent","join","getLoginUrl","callbackUrl","userHint","authOrigin","client_id","clientId","scope","response_type","state","redirect_uri","login_hint","getTokensFromAuthorizationCode","code","_a","_b","request","origin","form","client_secret","clientSecret","grant_type","Error","body","access_token","statusCode","assign","expires_at","Date","now","expires_in","GITHUB_SCOPES","getGithubLoginUrl","githubOrigin","githubClientId","getGithubTokensFromAuthorizationCode","githubClientSecret","respondWithFile","req","filename","response","promisify","readFile","__dirname","writeHead","length","end","socket","destroy","loginWithoutLocalhost","authUrl","info","underline","promptOnce","type","name","message","decode","id_token","loginWithLocalhostGoogle","successTemplate","loginWithLocalhost","loginWithLocalhostGitHub","getTokens","Promise","resolve","reject","server","createServer","query","parse","queryState","queryCode","close","listen","on","localhost","haveValidTokens","refreshToken","authScopes","hasTokens","oldScopesJSON","JSON","stringify","sort","newScopesJSON","hasSameScopes","isExpired","deleteAccount","defaultAccount","delete","remainingAccounts","filter","projectAccount","accountIndex","findAccountByRefreshToken","logoutCurrentSession","clearCredentials","refreshTokens","_c","googleOrigin","logOptions","skipRequestBody","skipQueryParams","skipResponseBody","status","context","error","data","thrown","original"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.logout = exports.getAccessToken = exports.findAccountByEmail = exports.loginGithub = exports.loginGoogle = exports.setGlobalDefaultAccount = exports.setProjectAccount = exports.loginAdditionalAccount = exports.selectAccount = exports.setRefreshToken = exports.setActiveAccount = exports.getAllAccounts = exports.getAdditionalAccounts = exports.getProjectDefaultAccount = exports.getGlobalDefaultAccount = void 0;\nconst clc = require(\"cli-color\");\nconst fs = require(\"fs\");\nconst jwt = require(\"jsonwebtoken\");\nconst http = require(\"http\");\nconst opn = require(\"open\");\nconst path = require(\"path\");\nconst portfinder = require(\"portfinder\");\nconst url = require(\"url\");\nconst util = require(\"util\");\nconst api = require(\"./api\");\nconst apiv2 = require(\"./apiv2\");\nconst configstore_1 = require(\"./configstore\");\nconst error_1 = require(\"./error\");\nconst utils = require(\"./utils\");\nconst logger_1 = require(\"./logger\");\nconst prompt_1 = require(\"./prompt\");\nconst scopes = require(\"./scopes\");\nconst defaultCredentials_1 = require(\"./defaultCredentials\");\nportfinder.basePort = 9005;\nfunction getGlobalDefaultAccount() {\n    const user = configstore_1.configstore.get(\"user\");\n    const tokens = configstore_1.configstore.get(\"tokens\");\n    if (!user || !tokens) {\n        return undefined;\n    }\n    return {\n        user,\n        tokens,\n    };\n}\nexports.getGlobalDefaultAccount = getGlobalDefaultAccount;\nfunction getProjectDefaultAccount(projectDir) {\n    if (!projectDir) {\n        return getGlobalDefaultAccount();\n    }\n    const activeAccounts = configstore_1.configstore.get(\"activeAccounts\") || {};\n    const email = activeAccounts[projectDir];\n    if (!email) {\n        return getGlobalDefaultAccount();\n    }\n    const allAccounts = getAllAccounts();\n    return allAccounts.find((a) => a.user.email === email);\n}\nexports.getProjectDefaultAccount = getProjectDefaultAccount;\nfunction getAdditionalAccounts() {\n    return configstore_1.configstore.get(\"additionalAccounts\") || [];\n}\nexports.getAdditionalAccounts = getAdditionalAccounts;\nfunction getAllAccounts() {\n    const res = [];\n    const defaultUser = getGlobalDefaultAccount();\n    if (defaultUser) {\n        res.push(defaultUser);\n    }\n    res.push(...getAdditionalAccounts());\n    return res;\n}\nexports.getAllAccounts = getAllAccounts;\nfunction setActiveAccount(options, account) {\n    if (account.tokens.refresh_token) {\n        setRefreshToken(account.tokens.refresh_token);\n    }\n    options.user = account.user;\n    options.tokens = account.tokens;\n}\nexports.setActiveAccount = setActiveAccount;\nfunction setRefreshToken(token) {\n    api.setRefreshToken(token);\n    apiv2.setRefreshToken(token);\n}\nexports.setRefreshToken = setRefreshToken;\nfunction selectAccount(account, projectRoot) {\n    const defaultUser = getProjectDefaultAccount(projectRoot);\n    if (!account) {\n        return defaultUser;\n    }\n    if (!defaultUser) {\n        throw new error_1.FirebaseError(`Account ${account} not found, have you run \"firebase login\"?`);\n    }\n    const matchingAccount = getAllAccounts().find((a) => a.user.email === account);\n    if (matchingAccount) {\n        return matchingAccount;\n    }\n    throw new error_1.FirebaseError(`Account ${account} not found, run \"firebase login:list\" to see existing accounts or \"firebase login:add\" to add a new one`);\n}\nexports.selectAccount = selectAccount;\nasync function loginAdditionalAccount(useLocalhost, email) {\n    const result = await loginGoogle(useLocalhost, email);\n    if (typeof result.user === \"string\") {\n        throw new error_1.FirebaseError(\"Failed to parse auth response, see debug log.\");\n    }\n    const resultEmail = result.user.email;\n    if (email && resultEmail !== email) {\n        utils.logWarning(`Chosen account ${resultEmail} does not match account hint ${email}`);\n    }\n    const allAccounts = getAllAccounts();\n    const newAccount = {\n        user: result.user,\n        tokens: result.tokens,\n    };\n    const existingAccount = allAccounts.find((a) => a.user.email === resultEmail);\n    if (existingAccount) {\n        utils.logWarning(`Already logged in as ${resultEmail}.`);\n        updateAccount(newAccount);\n    }\n    else {\n        const additionalAccounts = getAdditionalAccounts();\n        additionalAccounts.push(newAccount);\n        configstore_1.configstore.set(\"additionalAccounts\", additionalAccounts);\n    }\n    return newAccount;\n}\nexports.loginAdditionalAccount = loginAdditionalAccount;\nfunction setProjectAccount(projectDir, email) {\n    logger_1.logger.debug(`setProjectAccount(${projectDir}, ${email})`);\n    const activeAccounts = configstore_1.configstore.get(\"activeAccounts\") || {};\n    activeAccounts[projectDir] = email;\n    configstore_1.configstore.set(\"activeAccounts\", activeAccounts);\n}\nexports.setProjectAccount = setProjectAccount;\nfunction setGlobalDefaultAccount(account) {\n    configstore_1.configstore.set(\"user\", account.user);\n    configstore_1.configstore.set(\"tokens\", account.tokens);\n    const additionalAccounts = getAdditionalAccounts();\n    const index = additionalAccounts.findIndex((a) => a.user.email === account.user.email);\n    if (index >= 0) {\n        additionalAccounts.splice(index, 1);\n        configstore_1.configstore.set(\"additionalAccounts\", additionalAccounts);\n    }\n}\nexports.setGlobalDefaultAccount = setGlobalDefaultAccount;\nfunction open(url) {\n    opn(url).catch((err) => {\n        logger_1.logger.debug(\"Unable to open URL: \" + err.stack);\n    });\n}\nfunction invalidCredentialError() {\n    return new error_1.FirebaseError(\"Authentication Error: Your credentials are no longer valid. Please run \" +\n        clc.bold(\"firebase login --reauth\") +\n        \"\\n\\n\" +\n        \"For CI servers and headless environments, generate a new token with \" +\n        clc.bold(\"firebase login:ci\"), { exit: 1 });\n}\nconst FIFTEEN_MINUTES_IN_MS = 15 * 60 * 1000;\nconst SCOPES = [\n    scopes.EMAIL,\n    scopes.OPENID,\n    scopes.CLOUD_PROJECTS_READONLY,\n    scopes.FIREBASE_PLATFORM,\n    scopes.CLOUD_PLATFORM,\n];\nconst _nonce = Math.floor(Math.random() * (2 << 29) + 1).toString();\nconst getPort = portfinder.getPortPromise;\nlet lastAccessToken;\nfunction getCallbackUrl(port) {\n    if (typeof port === \"undefined\") {\n        return \"urn:ietf:wg:oauth:2.0:oob\";\n    }\n    return `http://localhost:${port}`;\n}\nfunction queryParamString(args) {\n    const tokens = [];\n    for (const [key, value] of Object.entries(args)) {\n        if (typeof value === \"string\") {\n            tokens.push(key + \"=\" + encodeURIComponent(value));\n        }\n    }\n    return tokens.join(\"&\");\n}\nfunction getLoginUrl(callbackUrl, userHint) {\n    return (api.authOrigin +\n        \"/o/oauth2/auth?\" +\n        queryParamString({\n            client_id: api.clientId,\n            scope: SCOPES.join(\" \"),\n            response_type: \"code\",\n            state: _nonce,\n            redirect_uri: callbackUrl,\n            login_hint: userHint,\n        }));\n}\nasync function getTokensFromAuthorizationCode(code, callbackUrl) {\n    var _a, _b;\n    let res;\n    try {\n        res = await api.request(\"POST\", \"/o/oauth2/token\", {\n            origin: api.authOrigin,\n            form: {\n                code: code,\n                client_id: api.clientId,\n                client_secret: api.clientSecret,\n                redirect_uri: callbackUrl,\n                grant_type: \"authorization_code\",\n            },\n        });\n    }\n    catch (err) {\n        if (err instanceof Error) {\n            logger_1.logger.debug(\"Token Fetch Error:\", err.stack || \"\");\n        }\n        else {\n            logger_1.logger.debug(\"Token Fetch Error\");\n        }\n        throw invalidCredentialError();\n    }\n    if (!((_a = res === null || res === void 0 ? void 0 : res.body) === null || _a === void 0 ? void 0 : _a.access_token) && !((_b = res === null || res === void 0 ? void 0 : res.body) === null || _b === void 0 ? void 0 : _b.refresh_token)) {\n        logger_1.logger.debug(\"Token Fetch Error:\", res.statusCode, res.body);\n        throw invalidCredentialError();\n    }\n    lastAccessToken = Object.assign({\n        expires_at: Date.now() + res.body.expires_in * 1000,\n    }, res.body);\n    return lastAccessToken;\n}\nconst GITHUB_SCOPES = [\"read:user\", \"repo\", \"public_repo\"];\nfunction getGithubLoginUrl(callbackUrl) {\n    return (api.githubOrigin +\n        \"/login/oauth/authorize?\" +\n        queryParamString({\n            client_id: api.githubClientId,\n            state: _nonce,\n            redirect_uri: callbackUrl,\n            scope: GITHUB_SCOPES.join(\" \"),\n        }));\n}\nasync function getGithubTokensFromAuthorizationCode(code, callbackUrl) {\n    const res = await api.request(\"POST\", \"/login/oauth/access_token\", {\n        origin: api.githubOrigin,\n        form: {\n            client_id: api.githubClientId,\n            client_secret: api.githubClientSecret,\n            code,\n            redirect_uri: callbackUrl,\n            state: _nonce,\n        },\n    });\n    return res.body.access_token;\n}\nasync function respondWithFile(req, res, statusCode, filename) {\n    const response = await util.promisify(fs.readFile)(path.join(__dirname, filename));\n    res.writeHead(statusCode, {\n        \"Content-Length\": response.length,\n        \"Content-Type\": \"text/html\",\n    });\n    res.end(response);\n    req.socket.destroy();\n}\nasync function loginWithoutLocalhost(userHint) {\n    const callbackUrl = getCallbackUrl();\n    const authUrl = getLoginUrl(callbackUrl, userHint);\n    logger_1.logger.info();\n    logger_1.logger.info(\"Visit this URL on any device to log in:\");\n    logger_1.logger.info(clc.bold.underline(authUrl));\n    logger_1.logger.info();\n    open(authUrl);\n    const code = await prompt_1.promptOnce({\n        type: \"input\",\n        name: \"code\",\n        message: \"Paste authorization code here:\",\n    });\n    const tokens = await getTokensFromAuthorizationCode(code, callbackUrl);\n    return {\n        user: jwt.decode(tokens.id_token),\n        tokens: tokens,\n        scopes: SCOPES,\n    };\n}\nasync function loginWithLocalhostGoogle(port, userHint) {\n    const callbackUrl = getCallbackUrl(port);\n    const authUrl = getLoginUrl(callbackUrl, userHint);\n    const successTemplate = \"../templates/loginSuccess.html\";\n    const tokens = await loginWithLocalhost(port, callbackUrl, authUrl, successTemplate, getTokensFromAuthorizationCode);\n    return {\n        user: jwt.decode(tokens.id_token),\n        tokens: tokens,\n        scopes: tokens.scopes,\n    };\n}\nasync function loginWithLocalhostGitHub(port) {\n    const callbackUrl = getCallbackUrl(port);\n    const authUrl = getGithubLoginUrl(callbackUrl);\n    const successTemplate = \"../templates/loginSuccessGithub.html\";\n    return loginWithLocalhost(port, callbackUrl, authUrl, successTemplate, getGithubTokensFromAuthorizationCode);\n}\nasync function loginWithLocalhost(port, callbackUrl, authUrl, successTemplate, getTokens) {\n    return new Promise((resolve, reject) => {\n        const server = http.createServer(async (req, res) => {\n            let tokens;\n            const query = url.parse(`${req.url}`, true).query || {};\n            const queryState = query.state;\n            const queryCode = query.code;\n            if (queryState !== _nonce || typeof queryCode !== \"string\") {\n                await respondWithFile(req, res, 400, \"../templates/loginFailure.html\");\n                reject(new error_1.FirebaseError(\"Unexpected error while logging in\"));\n                server.close();\n                return;\n            }\n            try {\n                const tokens = await getTokens(queryCode, callbackUrl);\n                await respondWithFile(req, res, 200, successTemplate);\n                resolve(tokens);\n            }\n            catch (err) {\n                await respondWithFile(req, res, 400, \"../templates/loginFailure.html\");\n                reject(err);\n            }\n            server.close();\n            return;\n        });\n        server.listen(port, () => {\n            logger_1.logger.info();\n            logger_1.logger.info(\"Visit this URL on this device to log in:\");\n            logger_1.logger.info(clc.bold.underline(authUrl));\n            logger_1.logger.info();\n            logger_1.logger.info(\"Waiting for authentication...\");\n            open(authUrl);\n        });\n        server.on(\"error\", (err) => {\n            reject(err);\n        });\n    });\n}\nasync function loginGoogle(localhost, userHint) {\n    if (localhost) {\n        const port = await getPort();\n        try {\n            const port = await getPort();\n            return await loginWithLocalhostGoogle(port, userHint);\n        }\n        catch (_a) {\n            return await loginWithoutLocalhost(userHint);\n        }\n    }\n    return await loginWithoutLocalhost(userHint);\n}\nexports.loginGoogle = loginGoogle;\nasync function loginGithub() {\n    const port = await getPort();\n    return loginWithLocalhostGitHub(port);\n}\nexports.loginGithub = loginGithub;\nfunction findAccountByEmail(email) {\n    return getAllAccounts().find((a) => a.user.email === email);\n}\nexports.findAccountByEmail = findAccountByEmail;\nfunction haveValidTokens(refreshToken, authScopes) {\n    var _a;\n    if (!(lastAccessToken === null || lastAccessToken === void 0 ? void 0 : lastAccessToken.access_token)) {\n        const tokens = configstore_1.configstore.get(\"tokens\");\n        if (refreshToken === (tokens === null || tokens === void 0 ? void 0 : tokens.refresh_token)) {\n            lastAccessToken = tokens;\n        }\n    }\n    const hasTokens = !!(lastAccessToken === null || lastAccessToken === void 0 ? void 0 : lastAccessToken.access_token);\n    const oldScopesJSON = JSON.stringify(((_a = lastAccessToken === null || lastAccessToken === void 0 ? void 0 : lastAccessToken.scopes) === null || _a === void 0 ? void 0 : _a.sort()) || []);\n    const newScopesJSON = JSON.stringify(authScopes.sort());\n    const hasSameScopes = oldScopesJSON === newScopesJSON;\n    const isExpired = ((lastAccessToken === null || lastAccessToken === void 0 ? void 0 : lastAccessToken.expires_at) || 0) < Date.now() + FIFTEEN_MINUTES_IN_MS;\n    return hasTokens && hasSameScopes && !isExpired;\n}\nfunction deleteAccount(account) {\n    const defaultAccount = getGlobalDefaultAccount();\n    if (account.user.email === (defaultAccount === null || defaultAccount === void 0 ? void 0 : defaultAccount.user.email)) {\n        configstore_1.configstore.delete(\"user\");\n        configstore_1.configstore.delete(\"tokens\");\n        configstore_1.configstore.delete(\"usage\");\n        configstore_1.configstore.delete(\"analytics-uuid\");\n    }\n    const additionalAccounts = getAdditionalAccounts();\n    const remainingAccounts = additionalAccounts.filter((a) => a.user.email !== account.user.email);\n    configstore_1.configstore.set(\"additionalAccounts\", remainingAccounts);\n    const activeAccounts = configstore_1.configstore.get(\"activeAccounts\") || {};\n    for (const [projectDir, projectAccount] of Object.entries(activeAccounts)) {\n        if (projectAccount === account.user.email) {\n            delete activeAccounts[projectDir];\n        }\n    }\n    configstore_1.configstore.set(\"activeAccounts\", activeAccounts);\n}\nfunction updateAccount(account) {\n    const defaultAccount = getGlobalDefaultAccount();\n    if (account.user.email === (defaultAccount === null || defaultAccount === void 0 ? void 0 : defaultAccount.user.email)) {\n        configstore_1.configstore.set(\"user\", account.user);\n        configstore_1.configstore.set(\"tokens\", account.tokens);\n    }\n    const additionalAccounts = getAdditionalAccounts();\n    const accountIndex = additionalAccounts.findIndex((a) => a.user.email === account.user.email);\n    if (accountIndex >= 0) {\n        additionalAccounts.splice(accountIndex, 1, account);\n        configstore_1.configstore.set(\"additionalAccounts\", additionalAccounts);\n    }\n}\nfunction findAccountByRefreshToken(refreshToken) {\n    return getAllAccounts().find((a) => a.tokens.refresh_token === refreshToken);\n}\nfunction logoutCurrentSession(refreshToken) {\n    const account = findAccountByRefreshToken(refreshToken);\n    if (!account) {\n        return;\n    }\n    defaultCredentials_1.clearCredentials(account);\n    deleteAccount(account);\n}\nasync function refreshTokens(refreshToken, authScopes) {\n    var _a, _b, _c;\n    logger_1.logger.debug(\"> refreshing access token with scopes:\", JSON.stringify(authScopes));\n    try {\n        const res = await api.request(\"POST\", \"/oauth2/v3/token\", {\n            origin: api.googleOrigin,\n            form: {\n                refresh_token: refreshToken,\n                client_id: api.clientId,\n                client_secret: api.clientSecret,\n                grant_type: \"refresh_token\",\n                scope: (authScopes || []).join(\" \"),\n            },\n            logOptions: { skipRequestBody: true, skipQueryParams: true, skipResponseBody: true },\n        });\n        if (res.status === 401 || res.status === 400) {\n            return { access_token: refreshToken };\n        }\n        if (typeof ((_a = res.body) === null || _a === void 0 ? void 0 : _a.access_token) !== \"string\") {\n            throw invalidCredentialError();\n        }\n        lastAccessToken = Object.assign({\n            expires_at: Date.now() + res.body.expires_in * 1000,\n            refresh_token: refreshToken,\n            scopes: authScopes,\n        }, res.body);\n        const account = findAccountByRefreshToken(refreshToken);\n        if (account && lastAccessToken) {\n            account.tokens = lastAccessToken;\n            updateAccount(account);\n        }\n        return lastAccessToken;\n    }\n    catch (err) {\n        if (((_c = (_b = err === null || err === void 0 ? void 0 : err.context) === null || _b === void 0 ? void 0 : _b.body) === null || _c === void 0 ? void 0 : _c.error) === \"invalid_scope\") {\n            throw new error_1.FirebaseError(\"This command requires new authorization scopes not granted to your current session. Please run \" +\n                clc.bold(\"firebase login --reauth\") +\n                \"\\n\\n\" +\n                \"For CI servers and headless environments, generate a new token with \" +\n                clc.bold(\"firebase login:ci\"), { exit: 1 });\n        }\n        throw invalidCredentialError();\n    }\n}\nasync function getAccessToken(refreshToken, authScopes) {\n    if (haveValidTokens(refreshToken, authScopes)) {\n        return lastAccessToken;\n    }\n    return refreshTokens(refreshToken, authScopes);\n}\nexports.getAccessToken = getAccessToken;\nasync function logout(refreshToken) {\n    if ((lastAccessToken === null || lastAccessToken === void 0 ? void 0 : lastAccessToken.refresh_token) === refreshToken) {\n        lastAccessToken = undefined;\n    }\n    logoutCurrentSession(refreshToken);\n    try {\n        await api.request(\"GET\", \"/o/oauth2/revoke\", {\n            origin: api.authOrigin,\n            data: {\n                token: refreshToken,\n            },\n        });\n    }\n    catch (thrown) {\n        const err = thrown instanceof Error ? thrown : new Error(thrown);\n        throw new error_1.FirebaseError(\"Authentication Error.\", {\n            exit: 1,\n            original: err,\n        });\n    }\n}\nexports.logout = logout;\n"]},"metadata":{},"sourceType":"script"}