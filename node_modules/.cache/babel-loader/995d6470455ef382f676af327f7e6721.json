{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.jobFromSpec = exports.createOrReplaceJob = exports.updateJob = exports.getJob = exports.deleteJob = exports.createJob = exports.assertValidJob = void 0;\n\nconst _ = require(\"lodash\");\n\nconst error_1 = require(\"../error\");\n\nconst logger_1 = require(\"../logger\");\n\nconst api = require(\"../api\");\n\nconst backend = require(\"../deploy/functions/backend\");\n\nconst proto = require(\"./proto\");\n\nconst VERSION = \"v1beta1\";\nconst DEFAULT_TIME_ZONE = \"America/Los_Angeles\";\n\nfunction assertValidJob(job) {\n  proto.assertOneOf(\"Scheduler Job\", job, \"target\", \"httpTarget\", \"pubsubTarget\");\n\n  if (job.httpTarget) {\n    proto.assertOneOf(\"Scheduler Job\", job.httpTarget, \"httpTarget.authorizationHeader\", \"oauthToken\", \"odicToken\");\n  }\n}\n\nexports.assertValidJob = assertValidJob;\n\nfunction createJob(job) {\n  const strippedName = job.name.substring(0, job.name.lastIndexOf(\"/\"));\n  return api.request(\"POST\", `/${VERSION}/${strippedName}`, {\n    auth: true,\n    origin: api.cloudschedulerOrigin,\n    data: Object.assign({\n      timeZone: DEFAULT_TIME_ZONE\n    }, job)\n  });\n}\n\nexports.createJob = createJob;\n\nfunction deleteJob(name) {\n  return api.request(\"DELETE\", `/${VERSION}/${name}`, {\n    auth: true,\n    origin: api.cloudschedulerOrigin\n  });\n}\n\nexports.deleteJob = deleteJob;\n\nfunction getJob(name) {\n  return api.request(\"GET\", `/${VERSION}/${name}`, {\n    auth: true,\n    origin: api.cloudschedulerOrigin,\n    resolveOnHTTPError: true\n  });\n}\n\nexports.getJob = getJob;\n\nfunction updateJob(job) {\n  return api.request(\"PATCH\", `/${VERSION}/${job.name}`, {\n    auth: true,\n    origin: api.cloudschedulerOrigin,\n    data: Object.assign({\n      timeZone: DEFAULT_TIME_ZONE\n    }, job)\n  });\n}\n\nexports.updateJob = updateJob;\n\nasync function createOrReplaceJob(job) {\n  var _a, _b;\n\n  const jobName = job.name.split(\"/\").pop();\n  const existingJob = await getJob(job.name);\n\n  if (existingJob.status === 404) {\n    let newJob;\n\n    try {\n      newJob = await createJob(job);\n    } catch (err) {\n      if (((_b = (_a = err === null || err === void 0 ? void 0 : err.context) === null || _a === void 0 ? void 0 : _a.response) === null || _b === void 0 ? void 0 : _b.statusCode) === 404) {\n        throw new error_1.FirebaseError(`Cloud resource location is not set for this project but scheduled functions require it. ` + `Please see this documentation for more details: https://firebase.google.com/docs/projects/locations.`);\n      }\n\n      throw new error_1.FirebaseError(`Failed to create scheduler job ${job.name}: ${err.message}`);\n    }\n\n    logger_1.logger.debug(`created scheduler job ${jobName}`);\n    return newJob;\n  }\n\n  if (!job.timeZone) {\n    job.timeZone = DEFAULT_TIME_ZONE;\n  }\n\n  if (isIdentical(existingJob.body, job)) {\n    logger_1.logger.debug(`scheduler job ${jobName} is up to date, no changes required`);\n    return;\n  }\n\n  const updatedJob = await updateJob(job);\n  logger_1.logger.debug(`updated scheduler job ${jobName}`);\n  return updatedJob;\n}\n\nexports.createOrReplaceJob = createOrReplaceJob;\n\nfunction isIdentical(job, otherJob) {\n  return job && otherJob && job.schedule === otherJob.schedule && job.timeZone === otherJob.timeZone && _.isEqual(job.retryConfig, otherJob.retryConfig);\n}\n\nfunction jobFromSpec(schedule, appEngineLocation) {\n  const job = {\n    name: backend.scheduleName(schedule, appEngineLocation),\n    schedule: schedule.schedule\n  };\n  proto.copyIfPresent(job, schedule, \"timeZone\", \"retryConfig\");\n\n  if (schedule.transport === \"https\") {\n    throw new error_1.FirebaseError(\"HTTPS transport for scheduled functions is not yet supported\");\n  }\n\n  job.pubsubTarget = {\n    topicName: backend.topicName(schedule),\n    attributes: {\n      scheduled: \"true\"\n    }\n  };\n  return job;\n}\n\nexports.jobFromSpec = jobFromSpec;","map":{"version":3,"sources":["/home/dev/Documentos/Projects/github-clone/node_modules/firebase-tools/lib/gcp/cloudscheduler.js"],"names":["Object","defineProperty","exports","value","jobFromSpec","createOrReplaceJob","updateJob","getJob","deleteJob","createJob","assertValidJob","_","require","error_1","logger_1","api","backend","proto","VERSION","DEFAULT_TIME_ZONE","job","assertOneOf","httpTarget","strippedName","name","substring","lastIndexOf","request","auth","origin","cloudschedulerOrigin","data","assign","timeZone","resolveOnHTTPError","_a","_b","jobName","split","pop","existingJob","status","newJob","err","context","response","statusCode","FirebaseError","message","logger","debug","isIdentical","body","updatedJob","otherJob","schedule","isEqual","retryConfig","appEngineLocation","scheduleName","copyIfPresent","transport","pubsubTarget","topicName","attributes","scheduled"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.jobFromSpec = exports.createOrReplaceJob = exports.updateJob = exports.getJob = exports.deleteJob = exports.createJob = exports.assertValidJob = void 0;\nconst _ = require(\"lodash\");\nconst error_1 = require(\"../error\");\nconst logger_1 = require(\"../logger\");\nconst api = require(\"../api\");\nconst backend = require(\"../deploy/functions/backend\");\nconst proto = require(\"./proto\");\nconst VERSION = \"v1beta1\";\nconst DEFAULT_TIME_ZONE = \"America/Los_Angeles\";\nfunction assertValidJob(job) {\n    proto.assertOneOf(\"Scheduler Job\", job, \"target\", \"httpTarget\", \"pubsubTarget\");\n    if (job.httpTarget) {\n        proto.assertOneOf(\"Scheduler Job\", job.httpTarget, \"httpTarget.authorizationHeader\", \"oauthToken\", \"odicToken\");\n    }\n}\nexports.assertValidJob = assertValidJob;\nfunction createJob(job) {\n    const strippedName = job.name.substring(0, job.name.lastIndexOf(\"/\"));\n    return api.request(\"POST\", `/${VERSION}/${strippedName}`, {\n        auth: true,\n        origin: api.cloudschedulerOrigin,\n        data: Object.assign({ timeZone: DEFAULT_TIME_ZONE }, job),\n    });\n}\nexports.createJob = createJob;\nfunction deleteJob(name) {\n    return api.request(\"DELETE\", `/${VERSION}/${name}`, {\n        auth: true,\n        origin: api.cloudschedulerOrigin,\n    });\n}\nexports.deleteJob = deleteJob;\nfunction getJob(name) {\n    return api.request(\"GET\", `/${VERSION}/${name}`, {\n        auth: true,\n        origin: api.cloudschedulerOrigin,\n        resolveOnHTTPError: true,\n    });\n}\nexports.getJob = getJob;\nfunction updateJob(job) {\n    return api.request(\"PATCH\", `/${VERSION}/${job.name}`, {\n        auth: true,\n        origin: api.cloudschedulerOrigin,\n        data: Object.assign({ timeZone: DEFAULT_TIME_ZONE }, job),\n    });\n}\nexports.updateJob = updateJob;\nasync function createOrReplaceJob(job) {\n    var _a, _b;\n    const jobName = job.name.split(\"/\").pop();\n    const existingJob = await getJob(job.name);\n    if (existingJob.status === 404) {\n        let newJob;\n        try {\n            newJob = await createJob(job);\n        }\n        catch (err) {\n            if (((_b = (_a = err === null || err === void 0 ? void 0 : err.context) === null || _a === void 0 ? void 0 : _a.response) === null || _b === void 0 ? void 0 : _b.statusCode) === 404) {\n                throw new error_1.FirebaseError(`Cloud resource location is not set for this project but scheduled functions require it. ` +\n                    `Please see this documentation for more details: https://firebase.google.com/docs/projects/locations.`);\n            }\n            throw new error_1.FirebaseError(`Failed to create scheduler job ${job.name}: ${err.message}`);\n        }\n        logger_1.logger.debug(`created scheduler job ${jobName}`);\n        return newJob;\n    }\n    if (!job.timeZone) {\n        job.timeZone = DEFAULT_TIME_ZONE;\n    }\n    if (isIdentical(existingJob.body, job)) {\n        logger_1.logger.debug(`scheduler job ${jobName} is up to date, no changes required`);\n        return;\n    }\n    const updatedJob = await updateJob(job);\n    logger_1.logger.debug(`updated scheduler job ${jobName}`);\n    return updatedJob;\n}\nexports.createOrReplaceJob = createOrReplaceJob;\nfunction isIdentical(job, otherJob) {\n    return (job &&\n        otherJob &&\n        job.schedule === otherJob.schedule &&\n        job.timeZone === otherJob.timeZone &&\n        _.isEqual(job.retryConfig, otherJob.retryConfig));\n}\nfunction jobFromSpec(schedule, appEngineLocation) {\n    const job = {\n        name: backend.scheduleName(schedule, appEngineLocation),\n        schedule: schedule.schedule,\n    };\n    proto.copyIfPresent(job, schedule, \"timeZone\", \"retryConfig\");\n    if (schedule.transport === \"https\") {\n        throw new error_1.FirebaseError(\"HTTPS transport for scheduled functions is not yet supported\");\n    }\n    job.pubsubTarget = {\n        topicName: backend.topicName(schedule),\n        attributes: {\n            scheduled: \"true\",\n        },\n    };\n    return job;\n}\nexports.jobFromSpec = jobFromSpec;\n"]},"metadata":{},"sourceType":"script"}