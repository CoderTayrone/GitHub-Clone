{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.findModuleRoot = exports.waitForBody = exports.getFunctionService = exports.getTemporarySocketPath = exports.getEmulatedTriggersFromDefinitions = exports.emulatedFunctionsByRegion = exports.EmulatedTrigger = exports.HttpConstants = exports.EmulatedTriggerType = void 0;\n\nconst _ = require(\"lodash\");\n\nconst os = require(\"os\");\n\nconst path = require(\"path\");\n\nconst fs = require(\"fs\");\n\nvar EmulatedTriggerType;\n\n(function (EmulatedTriggerType) {\n  EmulatedTriggerType[\"BACKGROUND\"] = \"BACKGROUND\";\n  EmulatedTriggerType[\"HTTPS\"] = \"HTTPS\";\n})(EmulatedTriggerType = exports.EmulatedTriggerType || (exports.EmulatedTriggerType = {}));\n\nconst memoryLookup = {\n  \"128MB\": 128,\n  \"256MB\": 256,\n  \"512MB\": 512,\n  \"1GB\": 1024,\n  \"2GB\": 2048,\n  \"4GB\": 4096\n};\n\nclass HttpConstants {}\n\nexports.HttpConstants = HttpConstants;\nHttpConstants.CALLABLE_AUTH_HEADER = \"x-callable-context-auth\";\nHttpConstants.ORIGINAL_AUTH_HEADER = \"x-original-auth\";\n\nclass EmulatedTrigger {\n  constructor(definition, module) {\n    this.definition = definition;\n    this.module = module;\n  }\n\n  get memoryLimitBytes() {\n    return memoryLookup[this.definition.availableMemoryMb || \"128MB\"] * 1024 * 1024;\n  }\n\n  get timeoutMs() {\n    if (typeof this.definition.timeout === \"number\") {\n      return this.definition.timeout * 1000;\n    } else {\n      return parseInt((this.definition.timeout || \"60s\").split(\"s\")[0], 10) * 1000;\n    }\n  }\n\n  getRawFunction() {\n    if (!this.module) {\n      throw new Error(\"EmulatedTrigger has not been provided a module.\");\n    }\n\n    const func = _.get(this.module, this.definition.entryPoint);\n\n    return func.__emulator_func || func;\n  }\n\n}\n\nexports.EmulatedTrigger = EmulatedTrigger;\n\nfunction emulatedFunctionsByRegion(definitions) {\n  const regionDefinitions = [];\n\n  for (const def of definitions) {\n    if (!def.regions) {\n      def.regions = [\"us-central1\"];\n    }\n\n    for (const region of def.regions) {\n      const defDeepCopy = JSON.parse(JSON.stringify(def));\n      defDeepCopy.regions = [region];\n      defDeepCopy.region = region;\n      defDeepCopy.id = `${region}-${defDeepCopy.name}`;\n      regionDefinitions.push(defDeepCopy);\n    }\n  }\n\n  return regionDefinitions;\n}\n\nexports.emulatedFunctionsByRegion = emulatedFunctionsByRegion;\n\nfunction getEmulatedTriggersFromDefinitions(definitions, module) {\n  return definitions.reduce((obj, definition) => {\n    obj[definition.id] = new EmulatedTrigger(definition, module);\n    return obj;\n  }, {});\n}\n\nexports.getEmulatedTriggersFromDefinitions = getEmulatedTriggersFromDefinitions;\n\nfunction getTemporarySocketPath(pid, cwd) {\n  if (process.platform === \"win32\") {\n    return path.join(\"\\\\\\\\?\\\\pipe\", cwd, pid.toString());\n  } else {\n    return path.join(os.tmpdir(), `fire_emu_${pid.toString()}.sock`);\n  }\n}\n\nexports.getTemporarySocketPath = getTemporarySocketPath;\n\nfunction getFunctionService(def) {\n  if (def.eventTrigger) {\n    return def.eventTrigger.service;\n  }\n\n  return \"unknown\";\n}\n\nexports.getFunctionService = getFunctionService;\n\nfunction waitForBody(req) {\n  let data = \"\";\n  return new Promise(resolve => {\n    req.on(\"data\", chunk => {\n      data += chunk;\n    });\n    req.on(\"end\", () => {\n      resolve(data);\n    });\n  });\n}\n\nexports.waitForBody = waitForBody;\n\nfunction findModuleRoot(moduleName, filepath) {\n  const hierarchy = filepath.split(path.sep);\n\n  for (let i = 0; i < hierarchy.length; i++) {\n    try {\n      let chunks = [];\n\n      if (i) {\n        chunks = hierarchy.slice(0, -i);\n      } else {\n        chunks = hierarchy;\n      }\n\n      const packagePath = path.join(chunks.join(path.sep), \"package.json\");\n      const serializedPackage = fs.readFileSync(packagePath, \"utf8\").toString();\n\n      if (JSON.parse(serializedPackage).name === moduleName) {\n        return chunks.join(\"/\");\n      }\n\n      break;\n    } catch (err) {}\n  }\n\n  return \"\";\n}\n\nexports.findModuleRoot = findModuleRoot;","map":{"version":3,"sources":["/home/dev/Documentos/Projects/github-clone/node_modules/firebase-tools/lib/emulator/functionsEmulatorShared.js"],"names":["Object","defineProperty","exports","value","findModuleRoot","waitForBody","getFunctionService","getTemporarySocketPath","getEmulatedTriggersFromDefinitions","emulatedFunctionsByRegion","EmulatedTrigger","HttpConstants","EmulatedTriggerType","_","require","os","path","fs","memoryLookup","CALLABLE_AUTH_HEADER","ORIGINAL_AUTH_HEADER","constructor","definition","module","memoryLimitBytes","availableMemoryMb","timeoutMs","timeout","parseInt","split","getRawFunction","Error","func","get","entryPoint","__emulator_func","definitions","regionDefinitions","def","regions","region","defDeepCopy","JSON","parse","stringify","id","name","push","reduce","obj","pid","cwd","process","platform","join","toString","tmpdir","eventTrigger","service","req","data","Promise","resolve","on","chunk","moduleName","filepath","hierarchy","sep","i","length","chunks","slice","packagePath","serializedPackage","readFileSync","err"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.findModuleRoot = exports.waitForBody = exports.getFunctionService = exports.getTemporarySocketPath = exports.getEmulatedTriggersFromDefinitions = exports.emulatedFunctionsByRegion = exports.EmulatedTrigger = exports.HttpConstants = exports.EmulatedTriggerType = void 0;\nconst _ = require(\"lodash\");\nconst os = require(\"os\");\nconst path = require(\"path\");\nconst fs = require(\"fs\");\nvar EmulatedTriggerType;\n(function (EmulatedTriggerType) {\n    EmulatedTriggerType[\"BACKGROUND\"] = \"BACKGROUND\";\n    EmulatedTriggerType[\"HTTPS\"] = \"HTTPS\";\n})(EmulatedTriggerType = exports.EmulatedTriggerType || (exports.EmulatedTriggerType = {}));\nconst memoryLookup = {\n    \"128MB\": 128,\n    \"256MB\": 256,\n    \"512MB\": 512,\n    \"1GB\": 1024,\n    \"2GB\": 2048,\n    \"4GB\": 4096,\n};\nclass HttpConstants {\n}\nexports.HttpConstants = HttpConstants;\nHttpConstants.CALLABLE_AUTH_HEADER = \"x-callable-context-auth\";\nHttpConstants.ORIGINAL_AUTH_HEADER = \"x-original-auth\";\nclass EmulatedTrigger {\n    constructor(definition, module) {\n        this.definition = definition;\n        this.module = module;\n    }\n    get memoryLimitBytes() {\n        return memoryLookup[this.definition.availableMemoryMb || \"128MB\"] * 1024 * 1024;\n    }\n    get timeoutMs() {\n        if (typeof this.definition.timeout === \"number\") {\n            return this.definition.timeout * 1000;\n        }\n        else {\n            return parseInt((this.definition.timeout || \"60s\").split(\"s\")[0], 10) * 1000;\n        }\n    }\n    getRawFunction() {\n        if (!this.module) {\n            throw new Error(\"EmulatedTrigger has not been provided a module.\");\n        }\n        const func = _.get(this.module, this.definition.entryPoint);\n        return func.__emulator_func || func;\n    }\n}\nexports.EmulatedTrigger = EmulatedTrigger;\nfunction emulatedFunctionsByRegion(definitions) {\n    const regionDefinitions = [];\n    for (const def of definitions) {\n        if (!def.regions) {\n            def.regions = [\"us-central1\"];\n        }\n        for (const region of def.regions) {\n            const defDeepCopy = JSON.parse(JSON.stringify(def));\n            defDeepCopy.regions = [region];\n            defDeepCopy.region = region;\n            defDeepCopy.id = `${region}-${defDeepCopy.name}`;\n            regionDefinitions.push(defDeepCopy);\n        }\n    }\n    return regionDefinitions;\n}\nexports.emulatedFunctionsByRegion = emulatedFunctionsByRegion;\nfunction getEmulatedTriggersFromDefinitions(definitions, module) {\n    return definitions.reduce((obj, definition) => {\n        obj[definition.id] = new EmulatedTrigger(definition, module);\n        return obj;\n    }, {});\n}\nexports.getEmulatedTriggersFromDefinitions = getEmulatedTriggersFromDefinitions;\nfunction getTemporarySocketPath(pid, cwd) {\n    if (process.platform === \"win32\") {\n        return path.join(\"\\\\\\\\?\\\\pipe\", cwd, pid.toString());\n    }\n    else {\n        return path.join(os.tmpdir(), `fire_emu_${pid.toString()}.sock`);\n    }\n}\nexports.getTemporarySocketPath = getTemporarySocketPath;\nfunction getFunctionService(def) {\n    if (def.eventTrigger) {\n        return def.eventTrigger.service;\n    }\n    return \"unknown\";\n}\nexports.getFunctionService = getFunctionService;\nfunction waitForBody(req) {\n    let data = \"\";\n    return new Promise((resolve) => {\n        req.on(\"data\", (chunk) => {\n            data += chunk;\n        });\n        req.on(\"end\", () => {\n            resolve(data);\n        });\n    });\n}\nexports.waitForBody = waitForBody;\nfunction findModuleRoot(moduleName, filepath) {\n    const hierarchy = filepath.split(path.sep);\n    for (let i = 0; i < hierarchy.length; i++) {\n        try {\n            let chunks = [];\n            if (i) {\n                chunks = hierarchy.slice(0, -i);\n            }\n            else {\n                chunks = hierarchy;\n            }\n            const packagePath = path.join(chunks.join(path.sep), \"package.json\");\n            const serializedPackage = fs.readFileSync(packagePath, \"utf8\").toString();\n            if (JSON.parse(serializedPackage).name === moduleName) {\n                return chunks.join(\"/\");\n            }\n            break;\n        }\n        catch (err) {\n        }\n    }\n    return \"\";\n}\nexports.findModuleRoot = findModuleRoot;\n"]},"metadata":{},"sourceType":"script"}